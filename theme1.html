<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Cards</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @font-face {
            font-family: 'CoockieRun';
            src: url('coockierun.ttf') format('truetype');
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }

        /* Добавляем обёртку и стили для контейнера */
        #wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            margin: auto;
            width: 90vw; /* Используем относительную единицу измерения */
            height: auto;
            aspect-ratio: 9 / 16;
            max-width: 400px; 
            max-height: 90vh; /* Используем относительную единицу измерения */
        }

        #flip-instruction {
            font-family: 'CoockieRun', sans-serif;
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }

        /* Контейнер для карточек */
        #card-container {
            display: flex;
            align-items: center;
            margin-bottom: auto; /* Добавляем отступ снизу для кнопок */
            position: relative; /* Для позиционирования меню */
        }

        /* Ваши стили для карточек */
        .card {
            width: 300px;
            height: 450px;
            perspective: 1000px;
            margin: 0 auto;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.3s;
            transform-style: preserve-3d;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            padding: 0px;
            
            border-radius: 10px;
        }

        .card-front {
            background: #fff;
        }

        .card-back {
            background: #f8f8f8;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0px;
            font-size: 35px;
            font-family: 'CoockieRun', sans-serif;
            color: #333;
            border: 1px solid black;
        }

        img {
            width: 100%;
            height: auto;
        }

        /* Изменяем стили для меню */
        /* Кнопка меню */
        #menu-button {
            position: absolute;
            right: 10px; /* Уменьшаем отступ с правой стороны */
            top: 20px; /* Отступ сверху для лучшего расположения */
            padding: 10px 20px;
            margin: 5px;
            font-size: 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #menu-button::before {
            content: "Меню";
            font-size: 16px;
            color: #ffffff;
        }

        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%; /* Растягиваем на всю ширину контейнера */
            margin-top: auto; /* Автоматический верхний отступ для выравнивания внизу */
            padding: 10px;
        }

        /* Кнопки управления */
        .control-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px; /* Отступ между кнопками */
        }

        .control-button.bad {
            background-color: #f44336;
        }

        .control-button.excellent {
            background-color: #2196F3; /* Синий цвет для кнопки "Отлично помню" */
        }

        /* Обновляем контейнер кнопок */
        #sound-button-container {
            display: flex;
            justify-content: center; /* Центрируем элементы */
            align-items: center;
            width: 100%; /* Растягиваем контейнер на всю ширину */
            padding-right: 0px;
            margin-top: 0px;
            position: relative; /* Для абсолютного позиционирования кнопки меню */
        }

        /* Центрирование кнопки звука */
        #sound-button {
            width: 100px;
            height: 100px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Новый контейнер для игры с обёрткой -->
    <div id="wrapper">
        <div id="gameContainer">
            <div id="flip-instruction">Нажми, чтобы перевернуть</div>
            <div id="card-container"></div>
            <div class="button-container">
                <button class="control-button bad" id="bad-button">Помню плохо</button>
                <button class="control-button good" id="good-button">Помню хорошо</button>
                <button class="control-button excellent" id="excellent-button">Отлично помню</button>
            </div>
            <div id="sound-button-container">
                <div id="menu-button" onclick="showMenu()"></div>
                <img src="sound_on.png" id="sound-button" alt="Включить звук" />
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram Mini App
        Telegram.WebApp.ready();
        
        // Установка темы в зависимости от темы Telegram
        if (Telegram.WebApp.themeParams.backgroundColor) {
            document.body.style.backgroundColor = Telegram.WebApp.themeParams.backgroundColor;
        }
    
        let currentCardIndex = 0;
        let cardsData = [];
        let cardPriorities = {}; // Объект для хранения приоритетов карточек
        let goodButtonPressCount = {}; // Счетчик для кнопки "Помню хорошо"
        let removedCards = []; // Массив удаленных карточек для временного исключения
        let currentAudio = null; // To keep track of the current audio object
        let sleepDuration = 30 * 60 * 1000; // 30 минут в миллисекундах
        let countdownInterval = null;
    
        // Загружаем данные и создаем карточки
        document.addEventListener('DOMContentLoaded', () => {
            fetch('cards.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    cardsData = data;
                    initializeCardData();
                    shuffleArray(cardsData);
                    
                    // Проверяем состояние таймера в localStorage
                    const sleepEndTime = localStorage.getItem('sleepEndTime');
                    if (sleepEndTime && Date.now() < sleepEndTime) {
                        startSleepTimer(sleepEndTime - Date.now());
                    } else {
                        showNextCard();
                    }
                })
                .catch(error => console.error('Ошибка загрузки JSON:', error));
        });
    
        // Инициализация данных карточек в localStorage
        function initializeCardData() {
            cardsData.forEach((card, index) => {
                const cardData = localStorage.getItem(`card_${index}`);
                if (cardData) {
                    cardPriorities[index] = JSON.parse(cardData).priority;
                } else {
                    cardPriorities[index] = { priority: 0 };
                }
                goodButtonPressCount[index] = 0;
            });
        }
    
        // Функция для сохранения данных карточки в localStorage
        function saveCardData(index) {
            localStorage.setItem(`card_${index}`, JSON.stringify({ priority: cardPriorities[index].priority }));
        }
    
        // Функция для случайного перемешивания массива
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    
        // Функция для показа следующей карточки
        function showNextCard() {
            const currentCard = document.querySelector('.card');
            if (currentCard) {
                currentCard.style.opacity = 0; // Плавное исчезновение текущей карточки
            }
            setTimeout(() => {
                // Проверяем, достиг ли индекс конца колоды, и начинаем новый круг
                if (currentCardIndex >= cardsData.length) {
                    currentCardIndex = 0;
                }
    
                if (cardsData.length > 0) {
                    createCard(cardsData[currentCardIndex]);
                } else {
                    startSleepTimer(sleepDuration); // Запускаем таймер для сна карточек
                }
    
                const newCard = document.querySelector('.card');
                if (newCard) {
                    newCard.style.opacity = 0; // Установить новую карточку невидимой
                    setTimeout(() => {
                        newCard.style.opacity = 1; // Плавное появление новой карточки
                    }, 50);
                }
            }, 500);
        }
    
        // Функция для создания карточки
        function createCard(cardData) {
            const container = document.getElementById('card-container');
            container.innerHTML = ''; // Очистить контейнер перед добавлением новой карточки
    
            const card = document.createElement('div');
            card.classList.add('card');
            
            const cardInner = document.createElement('div');
            cardInner.classList.add('card-inner');
            
            // Front of the card
            const cardFront = document.createElement('div');
            cardFront.classList.add('card-front');
            
            const img = document.createElement('img');
            img.src = cardData.image;
            cardFront.appendChild(img);
            cardFront.addEventListener('click', () => {
                card.classList.add('flipped');
            });
            
            // Back of the card
            const cardBack = document.createElement('div');
            cardBack.classList.add('card-back');
    
            const koreanWord = document.createElement('p');
            koreanWord.textContent = cardData.korean;
    
            const russianWord = document.createElement('p');
            russianWord.textContent = cardData.russian;
    
            cardBack.appendChild(koreanWord);
            cardBack.appendChild(russianWord);
    
            // Here we add the event listener to the back of the card as well
            cardBack.addEventListener('click', () => {
                card.classList.remove('flipped');
            });
    
            cardInner.appendChild(cardFront);
            cardInner.appendChild(cardBack);
            card.appendChild(cardInner);
    
            // Add the card to the container
            container.appendChild(card);
    
            // Play sound for the created card
            playSound(cardData.audio);
        }
    
        function playSound(audioSrc) {
    // If there's an existing audio playing, stop it first
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }

    // Create a new audio object
    currentAudio = new Audio(audioSrc);

    // Try to play the audio
    currentAudio.play().catch(error => {
        console.log('Autoplay was prevented:', error);
    });

    // Отслеживаем завершение воспроизведения
    currentAudio.onended = () => {
        // Оставляем кнопку звука активной после окончания воспроизведения
        document.getElementById('sound-button').style.pointerEvents = 'auto';
    };
}
    
        // Обработка кнопок "Помню плохо" и "Помню хорошо"
        document.getElementById('bad-button').addEventListener('click', () => {
            cardPriorities[currentCardIndex].priority += 1; // Увеличиваем приоритет
            goodButtonPressCount[currentCardIndex] = 0; // Сбросить счетчик "Помню хорошо"
            saveCardData(currentCardIndex);
            currentCardIndex = (currentCardIndex + 1) % cardsData.length; // Переход к следующей карточке
            showNextCard(); // Показываем следующую карточку
        });
    
        document.getElementById('good-button').addEventListener('click', () => {
            const indexToRemove = currentCardIndex; // Сохраняем индекс текущей карточки
            cardPriorities[indexToRemove].priority -= 1; // Уменьшаем приоритет
            goodButtonPressCount[indexToRemove] += 1; // Увеличиваем счетчик "Помню хорошо"
            saveCardData(indexToRemove);
    
            // Если нажали дважды "Помню хорошо", исключаем карточку на 30 минут
            if (goodButtonPressCount[indexToRemove] >= 2) {
                removeCardTemporarily(indexToRemove);
            } else {
                currentCardIndex = (currentCardIndex + 1) % cardsData.length; // Переход к следующей карточке
                showNextCard(); // Показываем следующую карточку
            }
        });
    
        // Обработка кнопки "Отлично помню"
        document.getElementById('excellent-button').addEventListener('click', () => {
            removeCardPermanently(currentCardIndex); // Убираем карточку из колоды
        });
    
        // Функция для временного удаления карточки на 30 минут
        function removeCardTemporarily(cardIndex) {
            const removedCard = cardsData[cardIndex]; // Сохраняем удаляемую карточку
            cardsData.splice(cardIndex, 1); // Удаляем карточку из колоды
            removedCards.push(removedCard); // Добавляем карточку в массив удаленных
            saveCardData(cardIndex);
    
            // Если все карточки временно удалены, запускаем таймер сна
            if (cardsData.length === 0) {
                startSleepTimer(sleepDuration);
            }
        }
    
        // Функция для запуска таймера сна карточек
        function startSleepTimer(duration) {
    const container = document.getElementById('card-container');
    container.innerHTML = ''; // Очистить контейнер

    // Создаем обертку для центрирования текста и таймера
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.justifyContent = 'center';
    wrapper.style.alignItems = 'center';
    wrapper.style.height = '100%'; // Занимаем всю высоту контейнера
    wrapper.style.fontFamily = 'CoockieRun, Arial, sans-serif'; // Используем подключенный шрифт
    wrapper.style.paddingTop = '200px';

    // Создаем сообщение "Карточки закончились"
    const message = document.createElement('div');
    message.textContent = 'Карточки закончились';
    message.style.fontSize = '24px';
    message.style.color = '#333';
    message.style.textAlign = 'center';
    message.style.marginBottom = '10px'; // Отступ между текстом и таймером

    // Создаем элемент для таймера
    const countdownElement = document.createElement('div');
    countdownElement.style.fontSize = '20px';

    // Добавляем элементы в обертку
    wrapper.appendChild(message);
    wrapper.appendChild(countdownElement);
    container.appendChild(wrapper);

    // Устанавливаем время завершения таймера в localStorage
    const sleepEndTime = Date.now() + duration;
    localStorage.setItem('sleepEndTime', sleepEndTime);

    // Начинаем обратный отсчет
    let countdown = Math.floor(duration / 1000); // Время обратного отсчета в секундах
    countdownElement.textContent = `Новые карточки через: ${Math.floor(countdown / 60)}:${countdown % 60 < 10 ? '0' : ''}${countdown % 60}`;

    // Запуск таймера обратного отсчета
    countdownInterval = setInterval(() => {
        countdown--;
        countdownElement.textContent = `Новые карточки через: ${Math.floor(countdown / 60)}:${countdown % 60 < 10 ? '0' : ''}${countdown % 60}`;
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            resetCardDeck(); // Перезапустить карточки
        }
    }, 1000);
}

    // Функция для возврата карточек после сна
    function resetCardDeck() {
        localStorage.removeItem('sleepEndTime'); // Удаляем время окончания сна из localStorage
        cardsData = cardsData.concat(removedCards); // Возвращаем временно удаленные карточки
        removedCards = []; // Очищаем массив удаленных карточек
        shuffleArray(cardsData); // Перемешиваем колоду
        currentCardIndex = 0; // Сбрасываем индекс текущей карточки
        showNextCard(); // Показываем следующую карточку
    }

    // Функция для постоянного удаления карточки
    function removeCardPermanently(cardIndex) {
        cardsData.splice(cardIndex, 1); // Удаляем карточку из колоды навсегда
        if (currentCardIndex >= cardsData.length) {
            currentCardIndex = 0; // Если индекс вне диапазона, сбросить на 0
        }
        showNextCard(); // Показываем следующую карточку
    }

    // Обработка кнопки звука
    document.getElementById('sound-button').addEventListener('click', () => {
        if (currentAudio && currentAudio.paused) {
            currentAudio.play();
        }
    });

    // Функция для отображения меню (пустая пока что)
    function showMenu() {
        window.location.href = 'index.html'; // Временная реализация для отображения, что меню открыто
    }

    // Телеграмм расширение для получения размеров окна
    if (window.Telegram.WebApp) {
        Telegram.WebApp.expand(); // Расширяем приложение до полного экрана
    }
</script>

    
</body>
</html>

            
